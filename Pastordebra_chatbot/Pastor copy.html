<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pastor Debra AI — Counsel & Destiny Themes</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{ --bg:#0b0f14; --panel:#11161c; --panel-2:#0f141a; --card:#141a22;
    --accent:#7dd3fc; --accent-2:#60a5fa; --text:#e5edf5; --muted:#9db0c3;
    --success:#22c55e; --warning:#f59e0b; --danger:#ef4444; --shadow:0 8px 30px rgba(0,0,0,.35); --radius:16px }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0; background:linear-gradient(180deg,#0a0e13,#0a1118 30%, #0b1118 100%); color:var(--text); font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,Helvetica,sans-serif}
  .app-header{position:sticky; top:0; z-index:40; display:flex; align-items:center; gap:16px; padding:14px 18px; background:linear-gradient(180deg,rgba(8,12,17,.9),rgba(8,12,17,.6)); border-bottom:1px solid rgba(125,211,252,.15); backdrop-filter: blur(8px)}
  .brand{display:flex; align-items:center; gap:12px; font-weight:800; letter-spacing:.2px; font-size:18px}
  .brand .logo{width:38px; height:38px; border-radius:10px; background: radial-gradient(120px 100px at 20% 25%,#7dd3fc 0,#60a5fa 35%,#3b82f6 70%,#1d4ed8 100%); box-shadow:0 8px 24px rgba(99,102,241,.35), inset 0 0 48px rgba(255,255,255,.12)}
  .header-actions{margin-left:auto; display:flex; gap:10px; align-items:center}
  .chip{display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border:1px solid rgba(125,211,252,.22); background:rgba(17,24,39,.45); color:var(--text); border-radius:999px; font-size:12px}
  .btn{appearance:none; border:none; cursor:pointer; border-radius:10px; padding:10px 14px; font-weight:600; color:#081018; background:linear-gradient(180deg,#7dd3fc,#60a5fa); box-shadow:var(--shadow)}
  .btn.secondary{background:#19202a; color:var(--text); border:1px solid rgba(125,211,252,.22)}
  .select{background:#141a22; color:var(--text); border:1px solid rgba(125,211,252,.22); border-radius:10px; padding:9px 12px}
  .grid{display:grid; grid-template-columns: 320px 1fr 380px; gap:16px; padding:16px; max-width:1600px; margin:0 auto}
  @media (max-width: 1300px){ .grid{grid-template-columns: 260px 1fr 360px} }
  @media (max-width: 1100px){ .grid{grid-template-columns: 1fr} }
  .panel{background: linear-gradient(180deg, var(--panel), var(--panel-2)); border:1px solid rgba(125,211,252,.18); border-radius:var(--radius); box-shadow:var(--shadow)}
  .panel h3{margin:0; padding:14px 16px; border-bottom:1px solid rgba(125,211,252,.12); font-size:14px; letter-spacing:.3px; color:var(--muted)}
  .videos{padding:12px; display:grid; grid-template-columns:1fr; gap:12px; max-height: calc(100vh - 220px); overflow:auto}
  .vid-card{display:grid; grid-template-columns:104px 1fr; gap:10px; padding:10px; border-radius:12px; background:var(--card); border:1px solid rgba(125,211,252,.08); cursor:pointer; transition: transform .12s ease, border-color .12s ease, background .12s ease}
  .vid-card:hover{ transform:translateY(-2px); border-color:rgba(125,211,252,.25); background:#16202a }
  .thumb{ width:100%; aspect-ratio:16/9; border-radius:10px; background:#0b1220; display:grid; place-items:center; color:#8ab7d8; font-size:12px }
  .vid-title{ font-weight:600; line-height:1.2 }
  .vid-meta{ color:var(--muted); font-size:12px; margin-top:6px}
  .chat{display:grid; grid-template-rows: auto auto 1fr auto; height: calc(100vh - 150px); background: linear-gradient(180deg, #0f151d, #0e141b 60%, #0c1218); border:1px solid rgba(125,211,252,.18); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden}
  .hero{position:relative; padding:18px; border-bottom:1px solid rgba(125,211,252,.12);
    background: radial-gradient(600px 180px at 20% -30%, rgba(96,165,250,.18) 0, rgba(96,165,250,0) 60%), radial-gradient(600px 180px at 80% -30%, rgba(125,211,252,.18) 0, rgba(125,211,252,0) 60%)}
  .hero h2{margin:.2rem 0 .6rem 0; font-size:22px}
  .hero p{margin:0; color:var(--muted); font-size:14px}
  .player{aspect-ratio:16/9; width:100%; border: none; border-radius:12px; background:#000; box-shadow:var(--shadow)}
  .suggest{ display:flex; flex-wrap:wrap; gap:8px; padding:10px 14px; border-bottom:1px solid rgba(125,211,252,.08); background: rgba(20,26,34,.6)}
  .pill{padding:8px 10px; border:1px solid rgba(125,211,252,.2); border-radius:999px; color:var(--muted); font-size:12px; cursor:pointer; background:#131a22}
  .messages{padding:18px; overflow:auto; display:flex; flex-direction:column; gap:12px}
  .bubble{max-width: 82%; padding:12px 14px; border-radius:16px; line-height:1.45; white-space:pre-wrap; border:1px solid rgba(125,211,252,.15); box-shadow: 0 2px 16px rgba(0,0,0,.25); position:relative}
  .bubble.user{ background:#1b2430; align-self:flex-end; border-top-right-radius:6px }
  .bubble.bot{ background:#121a23; align-self:flex-start; border-top-left-radius:6px }
  .model-tag{ position:absolute; top:-10px; right:10px; font-size:10px; letter-spacing:.3px; color:#8fb0c9; background:#0a121a; border:1px solid rgba(125,211,252,.18); padding:2px 6px; border-radius:999px }
  .cite{margin-top:10px; padding:10px; border-radius:10px; background:#0f1720; border:1px solid rgba(125,211,252,.12); color:#9db0c3; font-size:12px}
  .inputbar{display:grid; grid-template-columns: 1fr auto; gap:10px; padding:10px; border-top:1px solid rgba(125,211,252,.12); background: linear-gradient(180deg, #0f151d, #0f151d)}
  .textbox{width:100%; resize:none; min-height:48px; max-height:160px; color:var(--text); background:#0f141a; border:1px solid rgba(125,211,252,.25); border-radius:12px; padding:12px; outline:none}
  .sendbtn{ padding:12px 16px; border-radius:12px; border:1px solid rgba(125,211,252,.25); background:linear-gradient(180deg,#7dd3fc,#60a5fa); color:#081018; font-weight:800; box-shadow:var(--shadow); cursor:pointer }
  .sendbtn[disabled]{ opacity:.6; cursor:not-allowed }
  .typing{ align-self:flex-start; background:#0f1620; border:1px dashed rgba(125,211,252,.25); color:#9db0c3 }
  .stack{ display:flex; flex-direction:column; gap:14px; padding:14px }
  .card{background:var(--card); border-radius:14px; border:1px solid rgba(125,211,252,.18); padding:14px; box-shadow:var(--shadow)}
  .field{ display:grid; gap:6px; margin-bottom:10px }
  .input{background:#0f141a; color:var(--text); border:1px solid rgba(125,211,252,.22); border-radius:10px; padding:10px 12px; outline:none}
  .small{ font-size:12px; color:var(--muted) }
  .title{ font-weight:700; margin-bottom:8px }
  .badge{ display:inline-block; padding:4px 8px; font-size:12px; color:#081018; background:linear-gradient(180deg,#7dd3fc,#60a5fa); border-radius:999px; font-weight:700 }
  .muted{ color:var(--muted) }
  .split{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
  .btn.ghost{ background:#0f141a; color:var(--text); border:1px solid rgba(125,211,252,.22) }
  .hr{ height:1px; background:rgba(125,211,252,.12); border:none; margin:10px 0 }
  .notice{ font-size:11.5px; color:#90a7b9 }
  .footer{ text-align:center; color:#7a91a7; font-size:12px; padding:18px 10px }
  a,a:visited{ color:#a6e3ff; text-decoration:none }
</style>
</head>
<body>
<header class="app-header">
  <div class="brand">
    <div class="logo" aria-hidden="true"></div>
    <div>Pastor Debra <span style="opacity:.7; font-weight:600">AI</span></div>
  </div>
  <div class="header-actions">
    <select id="modelSelect" class="select" title="Model routing">
      <option value="auto" selected>Auto (Router)</option>
      <option value="t5">Force T5</option>
      <option value="gpt">Force GPT</option>
    </select>
    <div id="healthChip" class="chip" title="Status and corpus counts">Health: <span id="healthText">checking…</span></div>
    <button class="btn secondary" id="reloadBtn" title="Hot reload corpora on the server">Reload</button>
  </div>
</header>

<main class="grid">
  <aside class="panel">
    <h3>Clips & Teachings</h3>
    <div style="padding:12px">
      <div id="playerWrap" class="card" style="padding:0; overflow:hidden">
        <iframe id="player" class="player" src="" allow="autoplay; clipboard-write; encrypted-media; picture-in-picture" allowfullscreen></iframe>
      </div>
    </div>
    <div class="videos" id="videosList"></div>
  </aside>

  <section class="chat">
    <div class="hero">
      <h2>“Speak, Lord — Your servant is listening.”</h2>
      <p>I’m Pastor Debra Jordan. Bring me your questions — I’ll pray with you, share Scripture, and offer Christ-centered counsel.</p>
    </div>

    <div class="suggest" id="quickRow">
      <div class="pill" data-text="Pastor Debra, I feel anxious. Please pray with me and share one Scripture and one step I can take today.">Prayer for Anxiety</div>
      <div class="pill" data-text="Pastor Debra, give me biblical counsel for my marriage — what’s one step I can take today?">Marriage Counsel</div>
      <div class="pill" data-text="Pastor Debra, help me discern my calling. What’s a wise next step?">Calling & Purpose</div>
      <div class="pill" data-text="Pastor Debra, would you share an encouragement for my week?">Weekly Encouragement</div>
      <div class="pill" id="useNameDob">Use my Name & DOB</div>
    </div>

    <div class="messages" id="messages"></div>

    <div class="inputbar">
      <textarea id="textbox" class="textbox" placeholder="Type a message… (Shift+Enter for new line)"></textarea>
      <button id="sendBtn" class="sendbtn">Send</button>
    </div>
  </section>

  <aside class="panel">
    <h3>Destiny Theme</h3>
    <div class="stack">

      <div class="card">
        <div class="title">Your Details</div>
        <div class="field">
          <label class="small">Full Name</label>
          <input id="nameInput" class="input" placeholder="e.g., Deborah Jordan" autocomplete="name">
        </div>
        <div class="field">
          <label class="small">Date of Birth</label>
          <input id="dobInput" class="input" placeholder="YYYY-MM-DD (or any digits)" inputmode="numeric" autocomplete="bday">
          <div class="notice">Computed with Pythagorean mapping; 11/22/33 are preserved.</div>
        </div>
        <div class="split">
          <button id="calcBtn" class="btn">Compute & Reveal</button>
          <button id="insertBtn" class="btn ghost">Insert to Chat</button>
        </div>
      </div>

      <div id="resultCard" class="card" style="display:none">
        <div class="split" style="justify-content:space-between">
          <div class="title">Theme Result</div>
          <span id="themeBadge" class="badge">Theme ?</span>
        </div>
        <div id="themeOrigin" class="muted small"></div>
        <div class="hr"></div>
        <div id="themeAnswer" style="white-space:pre-wrap; line-height:1.45"></div>
        <div id="themeQuestion" class="small muted" style="margin-top:8px"></div>
        <div class="hr"></div>
        <div class="split">
          <button id="askAboutThemeBtn" class="btn">Ask Pastor Debra about this</button>
          <button id="copyThemeBtn" class="btn ghost">Copy Guidance</button>
        </div>
      </div>

      <div class="card">
        <div class="title">Notes</div>
        <div class="notice">
          I offer spiritual encouragement and biblical wisdom. I am not a medical, legal, or financial advisor.
        </div>
      </div>

    </div>
  </aside>
</main>

<div class="footer">
  © <span id="year"></span> Pastor Debra AI • “He who began a good work in you will carry it to completion.”
</div>

<script>
const API_BASE = (location.protocol.startsWith('http') ? '' : 'http://localhost:8000');

/* ------- Destiny Themes (embedded) ------- */
const destinyThemesDataArray=[{"id":86,"category":"destiny_theme","question":"What is the Christian meaning and guidance for Destiny Theme 1?","answer":"Beloved, 1 carries a pioneer grace—the courage to begin what others only imagine. The Lord whispers, “Be strong and courageous… for the Lord your God is with you” (Joshua 1:9). Lead, but lead low. Start with prayer, write the vision, and take the first obedient step. Invite one wise voice to speak truth into your plans so zeal doesn’t outrun wisdom. Declare: I move first, but never alone—God goes before me.","label":86},{"id":87,"category":"destiny_theme","question":"What is the Christian meaning and guidance for Destiny Theme 2?","answer":"2 carries the anointing of the peacemaker—an ezer-kind of help that restores bridges. “Two are better than one… if either falls, one can help the other up” (Ecclesiastes 4:9–10). Keep the peace without losing yourself: set holy boundaries, tell the truth in love, and reconcile without enabling. Your listening is ministry. Declare: I honor God by honoring people; I help without disappearing.","label":87},{"id":88,"category":"destiny_theme","question":"What is the Christian meaning and guidance for Destiny Theme 3?","answer":"3 is the psalmist’s banner—joyful expression that lifts hearts toward God. “Sing to the Lord a new song” (Psalm 96:1). Create something small each day—song, sentence, testimony—and use your words to bless, not to bruise (Proverbs 18:21). Let celebration become intercession with melody. Declare: My voice is anointed; I release beauty that heals.","label":88},{"id":89,"category":"destiny_theme","question":"What is the Christian meaning and guidance for Destiny Theme 4?","answer":"4 is the builder’s mantle—order, foundations, rootedness. “He is like a tree planted by streams of water” (Psalm 1:3). Choose a simple rule of life: Scripture, prayer, rest, service. Finish what you start; let excellence be worship. God will trust you with more as you steward what you have. Declare: I build on the Rock; what I plant will flourish.","label":89},{"id":90,"category":"destiny_theme","question":"What is the Christian meaning and guidance for Destiny Theme 5?","answer":"5 carries holy flexibility—freedom that sets captives free. “It is for freedom that Christ has set us free” (Galatians 5:1). Channel your love of change into mission, not escape. Fast one pleasure weekly to anchor freedom in Christ, not novelty. Travel light and carry good news. Declare: I am free to obey; my change becomes someone else’s breakthrough.","label":90},{"id":91,"category":"destiny_theme","question":"What is the Christian meaning and guidance for Destiny Theme 6?","answer":"6 bears the keeper’s heart—nurture, responsibility, covenant care. “Above all these put on love, which binds everything together” (Colossians 3:14). Serve without a savior complex. Guard Sabbath so care flows from overflow, not exhaustion. Lead your household in prayer and practical mercy. Declare: Love is my language; I carry people to Jesus, not to myself.","label":91},{"id":92,"category":"destiny_theme","question":"What is the Christian meaning and guidance for Destiny Theme 7?","answer":"7 walks the path of the mystic scholar—wisdom sought in stillness. “If any of you lacks wisdom, let him ask God” (James 1:5). Keep a daily appointment with silence and Scripture; then bring your insight back to community so knowledge matures into love. Declare: God speaks in my stillness; I walk in revealed wisdom.","label":92},{"id":93,"category":"destiny_theme","question":"What is the Christian meaning and guidance for Destiny Theme 8?","answer":"8 is stewardship of influence—authority that serves justice and mercy. “It is He who gives you power to get wealth” (Deuteronomy 8:18). Treat resources like a trust, not a trophy: tithe, budget, bless. Be bold in negotiations and tender in generosity; champion the voiceless. Declare: I steward power righteously; increase serves the Kingdom.","label":93},{"id":94,"category":"destiny_theme","question":"What is the Christian meaning and guidance for Destiny Theme 9?","answer":"9 carries compassionate finishing—mercy that brings closure and healing. “If you pour yourself out for the hungry… your gloom will be as the noonday” (Isaiah 58:10). Say yes to assignments that mend the broken—and actually close the loops: forgive, follow up, finish. Keep boundaries so compassion can last. Declare: I finish with mercy; healing follows my steps.","label":94},{"id":95,"category":"destiny_theme","question":"What is the Christian meaning and guidance for Destiny Theme 11?","answer":"11 is the beacon—prophetic clarity that points to Jesus. “You are the light of the world… let your light shine” (Matthew 5:14–16). Keep your lamp trimmed: purity, prayer, accountability. Write what you see, test it by the Word, and speak truth in love—revelation unto redemption. Declare: I carry light without pride; illumination serves salvation.","label":95},{"id":96,"category":"destiny_theme","question":"What is the Christian meaning and guidance for Destiny Theme 22?","answer":"22 is the repairer—master builder for families, ministries, and cities. “You shall be called the repairer of the breach” (Isaiah 58:12). Think in blueprints: vision → phases → teams → timelines. Put prayer at the center and justice on the edges. Start small; scale holy. Declare: By God’s grace I rebuild; what was broken will live again.","label":96},{"id":97,"category":"destiny_theme","question":"What is the Christian meaning and guidance for Destiny Theme 33?","answer":"33 is the servant-teacher—Christlike compassion with mature mentorship. “Have this mind among yourselves… [Christ] emptied Himself” (Philippians 2:5–7). Teach from a towel, not a throne (John 13). Make disciples at the table; pair sound doctrine with gentle presence. Suffer well, forgive quickly. Declare: I lead by lowering; love is my authority.","label":97}];
const destinyMap = (()=>{ const out={}; for(const row of destinyThemesDataArray){ const m=row.question.match(/Destiny\s*Theme\s*(\d+)/i); if(m) out[parseInt(m[1],10)]={id:row.id,question:row.question,answer:row.answer}; } return out; })();

/* ------- Utils ------- */
const qs = s=>document.querySelector(s);
const qsa = s=>Array.from(document.querySelectorAll(s));
const sleep = ms=>new Promise(r=>setTimeout(r,ms));
function apiURL(path){ return `${API_BASE}${path}`; }
async function fetchJSON(path,options={}){ const res=await fetch(apiURL(path),{headers:{'Content-Type':'application/json'},...options}); if(!res.ok){ const txt=await res.text(); throw new Error(`${res.status} ${res.statusText}: ${txt}`); } return await res.json(); }
function setHealth(statusText, ok=true, tip=''){ const chip=qs('#healthChip'); const el=qs('#healthText'); el.textContent=statusText; chip.style.borderColor=ok?'rgba(34,197,94,.45)':'rgba(239,68,68,.55)'; chip.title=tip||chip.title; }
function escapeHTML(s){ return (s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* ------- Videos ------- */
function ytIdFromUrl(url){ if(!url) return null; try{ const u=new URL(url); if(u.hostname.includes('youtu.be')) return u.pathname.slice(1); if(u.hostname.includes('youtube.com')) return u.searchParams.get('v'); }catch(e){} return null; }
function renderVideos(list){
  const wrap=qs('#videosList'); wrap.innerHTML='';
  list.forEach(v=>{
    const id=v.yt_id||ytIdFromUrl(v.url||'')||'';
    const thumb=v.thumbnail||(id?`https://i.ytimg.com/vi/${id}/hqdefault.jpg`: '');
    const el=document.createElement('div'); el.className='vid-card';
    el.innerHTML = `<div class="thumb">${thumb?`<img src="${thumb}" style="width:100%;height:100%;object-fit:cover;border-radius:10px" />`:'No preview'}</div>
      <div><div class="vid-title">${escapeHTML(v.title||'Untitled Clip')}</div><div class="vid-meta">${escapeHTML((v.duration||v.category||'').toString())}</div></div>`;
    el.addEventListener('click',()=>{
      const player=qs('#player');
      if(id){ player.src=`https://www.youtube.com/embed/${id}?rel=0&modestbranding=1&color=white`; }
      else if(v.url && v.url.endsWith('.mp4')){ player.src=v.url; }
      else{ player.src=''; alert('No playable source for this item.'); }
    });
    wrap.appendChild(el);
  });
}
async function loadVideos(){ try{ const data=await fetchJSON('/videos'); const list=(data && data.videos)||[]; renderVideos(list); if(list.length){ const first=list[0]; const id=first.yt_id||ytIdFromUrl(first.url||''); if(id) qs('#player').src=`https://www.youtube.com/embed/${id}?rel=0&modestbranding=1&color=white`; } }catch(e){ console.warn('videos error',e); renderVideos([]);} }

/* ------- Chat ------- */
const messages=[]; let sending=false; let typingEl=null;
function addMessage(role,text,cites=[],modelTag=''){
  const box=document.createElement('div'); box.className=`bubble ${role==='user'?'user':'bot'}`; box.textContent=text;
  if(modelTag && role!=='user'){ const tag=document.createElement('div'); tag.className='model-tag'; tag.textContent=modelTag.toUpperCase(); box.appendChild(tag); }
  if(role!=='user' && Array.isArray(cites) && cites.length){ const cite=document.createElement('div'); cite.className='cite'; cite.innerHTML=cites.map(c=>`<div><strong>${escapeHTML(c.source||'')}</strong> • <em>${escapeHTML(c.section||'')}</em><br/><span>${escapeHTML(c.snippet||'')}</span></div>`).join('<hr class="hr">'); box.appendChild(cite); }
  qs('#messages').appendChild(box); qs('#messages').scrollTop=qs('#messages').scrollHeight;
}
function showTyping(){ if(typingEl) return; typingEl=document.createElement('div'); typingEl.className='bubble bot typing'; typingEl.textContent='Typing…'; qs('#messages').appendChild(typingEl); qs('#messages').scrollTop=qs('#messages').scrollHeight; }
function hideTyping(){ if(typingEl){ typingEl.remove(); typingEl=null; } }

async function sendChat(userText){
  if(!userText || sending) return;
  const model = qs('#modelSelect').value || 'auto';
  addMessage('user', userText);
  messages.push({role:'user', text:userText});
  showTyping(); sending=true; qs('#sendBtn').setAttribute('disabled','true');
  try{
    const data=await fetchJSON('/chat',{method:'POST', body:JSON.stringify({messages, active_model:model})});
    const msg=(data && data.messages && data.messages[0])||{text:'(no response)'};
    hideTyping();
    addMessage('assistant', msg.text||'', msg.cites||[], msg.model||'');
    messages.push({role:'assistant', text: msg.text||''});
  }catch(e){
    hideTyping(); addMessage('assistant', "I’m sorry, I ran into an issue. Let’s try again.");
    console.error(e);
  }finally{
    sending=false; qs('#sendBtn').removeAttribute('disabled');
  }
}

/* Quick suggestions */
function bindQuickPrompts(){
  qsa('.pill').forEach(p=>{
    p.addEventListener('click', ()=>{
      if(p.id==='useNameDob'){
        const name=qs('#nameInput').value.trim();
        const dob =qs('#dobInput').value.trim();
        const {themeName, themeDob}=computeThemes(name,dob);
        const parts=[]; if(name) parts.push(`My name is ${name}`); if(dob) parts.push(`DOB: ${dob}`);
        if(themeDob) parts.push(`DOB Destiny Theme: ${themeDob}`); if(themeName) parts.push(`Name Destiny Theme: ${themeName}`);
        const joined=parts.join(' • ');
        const hint="Pastor Debra, would you pray for me, share one Scripture, and give me one practical next step?";
        const text = joined ? `${joined}. ${hint}` : `Pastor Debra, please pray for me, share one Scripture, and give me one practical next step.`;
        sendChat(text);
      } else { sendChat(p.dataset.text); }
    });
  });
}

/* ------- Destiny Theme (client + server validate) ------- */
const MASTER_SET=new Set([11,22,33]);
const LETTER_VALUES=(()=>{ const vals=[]; for(let i=0;i<26;i++) vals.push((i%9)+1); const map={}; 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('').forEach((ch,i)=>map[ch]=vals[i]); return map; })();
function reduceKeepMasters(n){ while(n>9 && !MASTER_SET.has(n)){ n=n.toString().split('').map(d=>+d).reduce((a,b)=>a+b,0); } return n; }
function computeThemeFromName(name){ const letters=(name||'').toUpperCase().match(/[A-Z]/g); if(!letters) return null; const total=letters.reduce((sum,ch)=>sum+(LETTER_VALUES[ch]||0),0); return reduceKeepMasters(total); }
function computeThemeFromDob(dob){ const digits=(dob||'').match(/\d/g); if(!digits) return null; const total=digits.map(d=>+d).reduce((a,b)=>a+b,0); return reduceKeepMasters(total); }
function computeThemes(name,dob){ return { themeName: computeThemeFromName(name) || null, themeDob: computeThemeFromDob(dob) || null }; }
function getThemeEntry(n){ return destinyMap[n] || null; }

function showThemeResult({ number, origin, entry }){
  const card=qs('#resultCard'), badge=qs('#themeBadge'), originEl=qs('#themeOrigin'), answerEl=qs('#themeAnswer'), questionEl=qs('#themeQuestion');
  if(!number || !entry){ card.style.display='none'; return; }
  badge.textContent=`Theme ${number}`;
  originEl.textContent=origin?`Derived from ${origin.toUpperCase()}`:'';
  answerEl.textContent=entry.answer||'';
  questionEl.textContent=entry.question||'';
  card.style.display='block';
}

async function handleCompute(){
  const name=qs('#nameInput').value.trim();
  const dob =qs('#dobInput').value.trim();
  const {themeName, themeDob}=computeThemes(name,dob);
  let chosen=themeDob||themeName||null;
  let origin=themeDob?'dob':(themeName?'name':'');
  let entry=chosen?getThemeEntry(chosen):null;

  (async()=>{ try{ const param=themeDob?`?dob=${encodeURIComponent(dob)}`:(themeName?`?name=${encodeURIComponent(name)}`:''); if(param){ const res=await fetchJSON('/destiny_theme'+param); if(res && res.entry && res.theme_number===chosen){ entry=res.entry||entry; showThemeResult({number:chosen, origin, entry}); } } }catch(e){} })();

  if(!chosen || !entry){ alert('Please enter a valid Name or DOB to compute a Destiny Theme.'); return; }
  showThemeResult({ number: chosen, origin, entry });
}

function insertDestinyToChat(){
  const name=qs('#nameInput').value.trim();
  const dob =qs('#dobInput').value.trim();
  if(qs('#resultCard').style.display==='none'){ alert('Compute your Destiny Theme first.'); return; }
  const badge=qs('#themeBadge').textContent; const themeNum=(badge.match(/\d+/)||[])[0]||'';
  const entry=getThemeEntry(parseInt(themeNum,10));
  const opener=name?`My name is ${name}`:`Hi`;
  const dobText=dob?` (DOB ${dob})`:'';
  const msg=`${opener}${dobText}. My Destiny Theme is ${themeNum}. Pastor Debra, would you give me personal counsel with one Scripture and one practical step?\n\n${entry?entry.answer:''}`;
  sendChat(msg);
}
function copyTheme(){ const txt=(qs('#themeAnswer').textContent||'').trim(); if(!txt) return; navigator.clipboard.writeText(txt).then(()=> alert('Guidance copied.')); }

/* ------- Health + Reload ------- */
async function loadHealth(){
  try{
    const h=await fetchJSON('/health'); const ok=!!(h && h.t5_loaded); const counts=(h && h.docs)||{};
    const tip=`Version: ${h.version||'n/a'}\nT5: ${ok ? 'loaded' : 'unavailable'}\n`+
              `PastorDebra: ${counts.PastorDebra||0}\nSession: ${counts.Session||0}\nFacesOfEve: ${counts.FacesOfEve||0}\nDestinyThemes: ${counts.DestinyThemes||0}\nVideos: ${counts.Videos||0}`;
    setHealth(ok?'OK':'Degraded', ok, tip);
  }catch(e){ setHealth('Offline', false); }
}
async function doReload(){ try{ const r=await fetchJSON('/reload',{method:'POST'}); const c=r && r.counts ? r.counts : {}; setHealth('Reloaded',true,`PastorDebra: ${c.PastorDebra||0}, Session: ${c.Session||0}, FacesOfEve: ${c.FacesOfEve||0}, DestinyThemes: ${c.DestinyThemes||0}, Videos: ${c.Videos||0}`); await sleep(600); loadHealth(); }catch(e){ setHealth('Reload failed', false); } }

/* ------- Init ------- */
function bindUI(){
  const sel=qs('#modelSelect'); const saved=localStorage.getItem('pd_model'); if(saved) sel.value=saved; sel.addEventListener('change',()=>localStorage.setItem('pd_model', sel.value));
  qs('#sendBtn').addEventListener('click',()=>{ const t=qs('#textbox').value.trim(); if(!t) return; qs('#textbox').value=''; sendChat(t); });
  qs('#textbox').addEventListener('keydown',(e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); qs('#sendBtn').click(); } });
  qs('#calcBtn').addEventListener('click', handleCompute);
  qs('#insertBtn').addEventListener('click', insertDestinyToChat);
  qs('#copyThemeBtn').addEventListener('click', copyTheme);
  qs('#askAboutThemeBtn').addEventListener('click', insertDestinyToChat);
  qs('#reloadBtn').addEventListener('click', doReload);
  bindQuickPrompts();
}
async function start(){ qs('#year').textContent=new Date().getFullYear(); bindUI(); loadHealth(); loadVideos(); addMessage('assistant',"Welcome, beloved. I’m Pastor Debra Jordan. Share your heart — or enter your name and DOB on the right and I’ll reflect with you on your Destiny Theme."); }
start();
</script>
</body>
</html>
