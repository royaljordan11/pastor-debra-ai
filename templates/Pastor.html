<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pastor Debra AI ‚Äî Counsel & Christ-Centered Destiny Theme</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#0b0f14;
    --panel:#11161c;
    --panel-2:#0f141a;
    --card:#141a22;
    --accent:#7dd3fc;
    --accent-2:#60a5fa;
    --text:#e5edf5;
    --muted:#9db0c3;
    --shadow:0 8px 30px rgba(0,0,0,.35);
    --radius:16px;
  }

  *{box-sizing:border-box}
  html,body{height:100%}

  body{
    margin:0;
    background:linear-gradient(180deg,#0a0e13,#0a1118 30%, #0b1118 100%);
    color:var(--text);
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,Helvetica,sans-serif;
  }

  /* ---------- HEADER ---------- */
  .app-header{
    position:sticky;
    top:0;
    z-index:40;
    display:flex;
    align-items:center;
    gap:16px;
    padding:14px 18px;
    background:linear-gradient(180deg,rgba(8,12,17,.9),rgba(8,12,17,.6));
    border-bottom:1px solid rgba(125,211,252,.15);
    backdrop-filter: blur(8px);
  }
  .brand{
    display:flex;
    align-items:center;
    gap:12px;
    font-weight:800;
    letter-spacing:.2px;
    font-size:18px;
  }
  .brand .logo{
    width:38px;
    height:38px;
    border-radius:10px;
    background: radial-gradient(120px 100px at 20% 25%,#7dd3fc 0,#60a5fa 35%,#3b82f6 70%,#1d4ed8 100%);
    box-shadow:0 8px 24px rgba(99,102,241,.35), inset 0 0 48px rgba(255,255,255,.12);
  }
  .header-actions{
    margin-left:auto;
    display:flex;
    gap:10px;
    align-items:center;
  }
  .btn{
    appearance:none;
    border:none;
    cursor:pointer;
    border-radius:10px;
    padding:10px 14px;
    font-weight:600;
    color:#081018;
    background:linear-gradient(180deg,#7dd3fc,#60a5fa);
    box-shadow:var(--shadow);
  }
  .btn.secondary{
    background:#19202a;
    color:var(--text);
    border:1px solid rgba(125,211,252,.22);
  }
  .select,
  .check{
    background:#19202a;
    color:var(--text);
    border:1px solid rgba(125,211,252,.22);
    border-radius:10px;
    padding:9px 10px;
    font-weight:600;
  }

  /* ---------- INTRO OVERLAY ---------- */
  .intro-wrap{
    position:fixed;
    inset:0;
    z-index:1000;
    display:flex;
    align-items:center;
    justify-content:center;
    background:#000;
    transition:opacity .3s ease;
  }
  .intro-hidden{opacity:0; pointer-events:none}
  .intro-inner{
    position:relative;
    width:min(1080px, 92vw);
    border-radius:16px;
    overflow:hidden;
    box-shadow: var(--shadow);
  }
  .intro-video{
    width:100%;
    height:auto;
    display:block;
  }
  .intro-topbar{
    position:absolute;
    inset:auto 0 0 0;
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:10px 12px;
    background:linear-gradient(180deg, rgba(0,0,0,0), rgba(0,0,0,.45));
  }
  .skip-btn{
    appearance:none;
    border:none;
    cursor:pointer;
    border-radius:999px;
    padding:8px 12px;
    font-weight:700;
    color:#081018;
    background:linear-gradient(180deg,#7dd3fc,#60a5fa);
  }
  .caption{
    position:absolute;
    left:12px;
    top:12px;
    padding:6px 10px;
    border-radius:999px;
    font-size:12px;
    background:rgba(0,0,0,.45);
    border:1px solid rgba(125,211,252,.25);
  }

  /* ---------- LAYOUT GRID (DESKTOP) ---------- */
  .grid{
    display:grid;
    grid-template-columns: 320px 1fr 380px;
    gap:16px;
    padding:14px 16px;
    max-width:1600px;
    margin:0 auto;
  }

  /* ---------- VIDEO SIDEBAR ---------- */
  .videos{
    padding:12px;
    display:grid;
    gap:12px;
    max-height: calc(100vh - 220px);
    overflow:auto;
  }
  .vid-card{
    display:grid;
    grid-template-columns:104px 1fr;
    gap:10px;
    padding:10px;
    border-radius:12px;
    background:var(--card);
    border:1px solid rgba(125,211,252,.08);
    cursor:pointer;
    transition: .12s ease;
  }

  .player-video,
  .player-iframe{
    aspect-ratio:16/9;
    width:100%;
    border-radius:12px;
    background:#000;
    border:none;
  }

  /* ---------- CHAT PANEL ---------- */
  .chat{
    display:grid;
    grid-template-rows: auto auto 1fr auto;
    height: calc(100vh - 150px);
    background: linear-gradient(180deg,#0f151d,#0e141b 60%,#0c1218);
    border:1px solid rgba(125,211,252,.18);
    border-radius:var(--radius);
    overflow:hidden;
  }
  .hero{
    padding:18px;
    border-bottom:1px solid rgba(125,211,252,.12);
  }
  .toolbar{
    display:flex;
    gap:10px;
    padding:10px 14px;
    border-bottom:1px solid rgba(125,211,252,.08);
  }
  .suggest{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    padding:10px 14px;
    border-bottom:1px solid rgba(125,211,252,.08);
  }

  .messages{
    padding:18px;
    overflow:auto;
    display:flex;
    flex-direction:column;
    gap:12px;
  }

  .bubble{
    max-width:82%;
    padding:12px 14px;
    border-radius:16px;
    line-height:1.45;
    border:1px solid rgba(125,211,252,.15);
  }

  .bubble.user{
    background:#1b2430;
    align-self:flex-end;
  }
  .bubble.bot{
    background:#121a23;
    align-self:flex-start;
  }

  .inputbar{
    display:grid;
    grid-template-columns:1fr auto;
    gap:10px;
    padding:10px;
    border-top:1px solid rgba(125,211,252,.12);
  }
  .textbox{
    min-height:48px;
    max-height:160px;
    color:var(--text);
    background:#0f141a;
    border:1px solid rgba(125,211,252,.25);
    border-radius:12px;
    padding:12px;
  }

  /* ---------- MOBILE VERSION (Accordion + Fixes) ---------- */

  @media (max-width: 900px) {

    #mainGrid,
    .grid {
      display:flex !important;
      flex-direction:column !important;
      width:100% !important;
      gap:16px !important;
    }

    section.chat,
    aside.panel {
      width:100% !important;
      max-width:100% !important;
    }

    section.chat,
    .chat {
      display:flex !important;
      flex-direction:column !important;
      height:auto !important;
      overflow:hidden !important;
    }

    /* Scrollable messages */
    .chat .messages {
      flex:1 1 auto !important;
      overflow-y:auto !important;
      -webkit-overflow-scrolling:touch;
      min-height:55vh !important;
    }

    /* Hide both side panels */
    aside.panel {
      display:none !important;
    }

    /* Accordion buttons */
    .accordion-toggle {
      width:100%;
      padding:14px 16px;
      font-size:16px;
      font-weight:600;
      background:#141a22;
      border:1px solid rgba(125,211,252,0.25);
      border-radius:12px;
      color:var(--text);
      cursor:pointer;
      text-align:left;
    }

    .accordion-open + aside.panel {
      display:block !important;
      margin-top:10px;
    }

    section.chat { order:1; }
    #teachingsAccordion { order:2; }
    #teachingsPanel { order:3; }
    #destinyAccordion { order:4; }
    #destinyPanel { order:5; }

  }
</style>
</head>

<body>

<!-- INTRO OVERLAY -->
<div id="intro" class="intro-wrap">
  <div class="intro-inner">
    <span class="caption">Welcome ‚Ä¢ Pastor Debra Jordan</span>

    <iframe 
      id="introIframe"
      class="intro-video"
      src="https://www.youtube.com/embed/WaNaM_OXxA4?autoplay=1&mute=1&modestbranding=1&rel=0"
      allow="autoplay; encrypted-media"
      allowfullscreen>
    </iframe>

    <div class="intro-topbar">
      <span></span>
      <button id="skipIntro" class="skip-btn">Skip Intro</button>
    </div>

    <button id="introCatch" class="intro-catch"></button>
  </div>
</div>

<header class="app-header">
  <div class="brand">
    <div class="logo"></div>
    <div>Pastor Debra <span style="opacity:.7;font-weight:600">AI</span></div>
  </div>

  <div class="header-actions">
    <select id="modelSelect" class="select">
      <option value="auto" selected>Model: Auto</option>
      <option value="t5">Model: T5 (local)</option>
      <option value="gpt">Model: GPT</option>
    </select>

    <label class="check">
      <input type="checkbox" id="noCacheChk" /> no-cache
    </label>

    <button class="btn secondary" id="reloadBtn">Reload</button>
  </div>
</header>


<!-- --------------------------------------------- -->
<!--  MOBILE ACCORDION BUTTONS (Visible on phones) -->
<!-- --------------------------------------------- -->
<button id="teachingsAccordion" class="accordion-toggle">üì∫ Clips & Teachings</button>


<!-- --------------------------------------------- -->
<!--  MAIN GRID LAYOUT                            -->
<!-- --------------------------------------------- -->
<main class="grid" id="mainGrid" style="opacity:0; transition:opacity .3s ease">

  <!-- LEFT PANEL (Teachings) -->
  <aside class="panel" id="teachingsPanel">
    <h3>Clips & Teachings</h3>

    <div style="padding:12px">
      <div class="card player-wrap">
        <video id="playerVideo" class="player-video" controls playsinline preload="metadata"></video>

        <iframe 
          id="playerIframe"
          class="player-iframe"
          allow="autoplay; encrypted-media; clipboard-write; picture-in-picture"
          allowfullscreen>
        </iframe>
      </div>
    </div>

    <div class="videos" id="videosList"></div>
  </aside>


  <!-- CENTER: CHAT -->
  <section class="chat" role="region" aria-label="Chat with Pastor Debra AI">
    <div class="hero">
      <h2>‚ÄúSpeak, Lord ‚Äî Your servant is listening.‚Äù</h2>
      <p>I‚Äôm Pastor Debra Jordan. Bring your heart ‚Äî I‚Äôll pray with you, open Scripture, and offer Christ-centered counsel.</p>
    </div>

    <!-- Toolbar -->
    <div class="toolbar">
      <div class="pill" data-text="Scripture: Psalm 46:10\nPastor Debra, help me be still before God today.">Be Still (Ps 46:10)</div>
      <div class="pill" id="propheticQuick">Prophetic Word</div>
      <div class="spacer"></div>
      <div class="small muted">Shift+Enter for new line</div>
    </div>

    <!-- Suggest Row -->
    <div class="suggest" id="quickRow">
      <div class="pill" data-text="Pastor Debra, I feel anxious. Please pray with me and share one Scripture and one step I can take today.">Prayer for Anxiety</div>
      <div class="pill" data-text="Pastor Debra, give me biblical counsel for my marriage ‚Äî what‚Äôs one step I can take today?">Marriage Counsel</div>
      <div class="pill" data-text="Pastor Debra, help me discern my calling. What‚Äôs a wise next step?">Calling & Purpose</div>
      <div class="pill" data-text="Pastor Debra, would you share an encouragement for my week?">Weekly Encouragement</div>
      <div class="pill" id="useNameDob">Use my Name & DOB</div>
    </div>

    <!-- Messages -->
    <div class="messages" id="messages" aria-live="polite"></div>

    <!-- Input -->
    <div class="inputbar">
      <textarea id="textbox" class="textbox" placeholder="Type a message‚Ä¶"></textarea>
      <button id="sendBtn" class="sendbtn">Send</button>
    </div>
  </section>


  <!-- RIGHT PANEL (Destiny Theme) -->
  <aside class="panel" id="destinyPanel">
    <h3>Christ-Centered Destiny Theme</h3>

    <div class="stack">
      <div class="card">
        <div class="title">Your Details</div>

        <div class="field">
          <label class="small">Full Name</label>
          <input id="nameInput" class="input" placeholder="e.g., Deborah Jordan" autocomplete="name">
        </div>

        <div class="field">
          <label class="small">Date of Birth <span class="muted">(optional)</span></label>
          <input id="dobInput" class="input" placeholder="YYYY-MM-DD" inputmode="numeric" autocomplete="bday">
        </div>

        <div id="calcNotice" class="small muted"></div>
        <div class="hr"></div>

        <button id="calcBtn" class="btn">Reveal your Christian Theme</button>
      </div>

      <div id="resultCard" class="card" style="display:none">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div class="title">Theme Result</div>
          <span id="themeBadge" class="badge">Your Theme</span>
        </div>

        <div id="themeOrigin" class="small muted"></div>

        <div class="hr"></div>
        <div id="themeAnswer" style="white-space:pre-wrap"></div>

        <div class="hr"></div>

        <button id="askAboutThemeBtn" class="btn">Ask Pastor Debra about this</button>
        <button id="copyThemeBtn" class="btn" style="background:#0f141a;color:var(--text);border:1px solid rgba(125,211,252,.22)">Copy Guidance</button>
      </div>

      <div class="card">
        <div class="title">Notes</div>
        <div class="small muted">
          I offer spiritual encouragement and biblical wisdom. I am not a medical, legal, or financial advisor.
        </div>
      </div>
    </div>
  </aside>

</main>


<!-- DESTINY accordion (mobile only) -->
<button id="destinyAccordion" class="accordion-toggle">‚ú® Destiny Theme</button>


<!-- FOOTER -->
<div class="footer">
  ¬© <span id="year"></span> Pastor Debra AI ‚Ä¢ ‚ÄúHe who began a good work in you will carry it to completion.‚Äù
</div>


<!-- TOAST -->
<div id="toast" class="toast"></div>


<!-- --------------------------------------------- -->
<!--  JAVASCRIPT SECTION                           -->
<!-- --------------------------------------------- -->
<script>
/* ============================================================
   INTRO LOGIC
============================================================ */
const introEl = document.getElementById('intro');
const introIframe = document.getElementById('introIframe');
const skipIntro = document.getElementById('skipIntro');
const introCatch = document.getElementById('introCatch');
const mainGrid = document.getElementById('mainGrid');

function revealApp() {
  if (!introEl || introEl.classList.contains('intro-hidden')) return;

  introIframe.src = "";  
  introEl.classList.add('intro-hidden');
  mainGrid.style.opacity = 1;

  setTimeout(() => introEl.remove(), 300);
}

['click','touchstart','pointerdown','keydown','wheel'].forEach(evt => {
  window.addEventListener(evt, revealApp, { passive:true });
});

skipIntro.addEventListener("click", revealApp);
introCatch.addEventListener("click", revealApp);


/* ============================================================
   ACCORDION LOGIC (MOBILE)
============================================================ */
function setupAccordion() {
  const tBtn = document.getElementById("teachingsAccordion");
  const dBtn = document.getElementById("destinyAccordion");
  const tPanel = document.getElementById("teachingsPanel");
  const dPanel = document.getElementById("destinyPanel");

  if (tBtn) {
    tBtn.addEventListener("click", () => {
      tBtn.classList.toggle("accordion-open");
      tPanel.style.display = tBtn.classList.contains("accordion-open") ? "block" : "none";
    });
  }

  if (dBtn) {
    dBtn.addEventListener("click", () => {
      dBtn.classList.toggle("accordion-open");
      dPanel.style.display = dBtn.classList.contains("accordion-open") ? "block" : "none";
    });
  }
}

setupAccordion();


/* ============================================================
   UTILITIES
============================================================ */
function qs(s){ return document.querySelector(s); }
function qsa(s){ return [...document.querySelectorAll(s)]; }

function toast(msg){
  const t = qs('#toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2000);
}


/* ============================================================
   VIDEO RENDERING
============================================================ */
function ytIdFromUrl(url){
  try {
    const u = new URL(url);
    if (u.hostname.includes('youtu.be')) return u.pathname.slice(1);
    if (u.hostname.includes('youtube.com')) return u.searchParams.get('v');
  } catch(e){}
  return null;
}

function showLocalVideo(src){
  const v = qs('#playerVideo');
  const f = qs('#playerIframe');
  try { v.pause(); } catch(e){}
  v.innerHTML = "";

  const s = document.createElement('source');
  s.src = src;
  v.appendChild(s);

  v.style.display = "block";
  f.style.display = "none";
  f.src = "";

  v.load();
  v.play().catch(()=>{});
}

function showYouTube(id){
  const v = qs('#playerVideo');
  const f = qs('#playerIframe');
  try { v.pause(); } catch(e){}
  v.innerHTML = "";
  v.style.display = "none";

  f.style.display = "block";
  f.src = `https://www.youtube.com/embed/${id}?rel=0&modestbranding=1`;
}

async function loadVideos(){
  let data = {};
  try {
    data = await fetch('/videos').then(r=>r.json());
  } catch(e){}
  
  let list = data.videos || [];

  const extraLocal = [
    { title:"Thankful People Are Thinking People", url:"momone.mp4", duration:"Teaching" },
    { title:"Wisdom and Prayer", url:"momtwo.mp4", duration:"Teaching" },
    { title:"The Power of Small Blessings", url:"momthree.mp4", duration:"Teaching" }
  ];

  if (list.length) {
    const first = list[0];
    first.title = "Pastor Debra Jordan Intro";
    list = [first, ...extraLocal, ...list.slice(1)];
  } else {
    list = extraLocal;
  }

  const wrap = qs('#videosList');
  wrap.innerHTML = "";

  list.forEach(v => {
    const id = v.yt_id || ytIdFromUrl(v.url);
    const thumb = id ? `https://i.ytimg.com/vi/${id}/hqdefault.jpg` : "";

    const el = document.createElement('div');
    el.className = "vid-card";
    el.innerHTML = `
      <div class="thumb">
        ${thumb ? `<img src="${thumb}" style="width:100%;height:100%;object-fit:cover;border-radius:10px" />` : "No Preview"}
      </div>
      <div>
        <div class="vid-title">${v.title}</div>
        <div class="vid-meta">${v.duration || ""}</div>
      </div>
    `;

    el.addEventListener("click", () => {
      if (id) showYouTube(id);
      else if (v.url.endsWith(".mp4") || v.url.endsWith(".mov")) showLocalVideo(v.url);
      else toast("No playable source.");
    });

    wrap.appendChild(el);
  });

  // Auto-play first
  const first = list[0];
  const id = first.yt_id || ytIdFromUrl(first.url);
  if (id) showYouTube(id);
  else if (first.url) showLocalVideo(first.url);
}


/* ============================================================
   CHAT SYSTEM
============================================================ */
let sending = false;
const messages = [];

function addMessage(role, text) {
  const box = document.createElement('div');
  box.className = `bubble ${role}`;
  box.innerHTML = text.replace(/\n/g,'<br>');
  qs('#messages').appendChild(box);
  qs('#messages').scrollTop = qs('#messages').scrollHeight;
}

async function sendChat(text){
  if (!text.trim() || sending) return;

  addMessage("user", text);
  messages.push({ role:"user", text });

  sending = true;

  addMessage("bot", "Typing‚Ä¶");

  let payload = { messages };

  try {
    const res = await fetch('/chat', {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify(payload)
    }).then(r=>r.json());

    const reply = res.messages?.[0]?.text || "(no response)";
    document.querySelectorAll(".bot").forEach(b=>{
      if (b.textContent === "Typing‚Ä¶") b.remove();
    });
    addMessage("bot", reply);

  } catch(e){
    addMessage("bot", "Something went wrong.");
  }

  sending = false;
}

qs('#sendBtn').addEventListener('click', () => {
  const t = qs('#textbox');
  const val = t.value;
  t.value = "";
  sendChat(val);
});

qs('#textbox').addEventListener('keydown', e => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    qs('#sendBtn').click();
  }
});


/* ============================================================
   DESTINY THEME LOGIC
============================================================ */
const MASTER_SET=new Set([11,22,33]);

const LETTER_VALUES = (() => {
  const m={};
  "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("").forEach((c,i)=>m[c]=(i%9)+1);
  return m;
})();

function reduceKeepMasters(n){
  while(n>9 && !MASTER_SET.has(n)){
    n = n.toString().split('').reduce((a,b)=>a+ +b,0);
  }
  return n;
}

function themeFromName(name){
  const letters = name.toUpperCase().match(/[A-Z]/g);
  if (!letters) return null;
  const total = letters.reduce((a,ch)=>a+(LETTER_VALUES[ch]||0),0);
  return reduceKeepMasters(total);
}

function themeFromDob(dob){
  const digits = dob.match(/\d/g);
  if (!digits) return null;
  const total = digits.reduce((a,b)=>a+ +b,0);
  return reduceKeepMasters(total);
}

const THEME_NAME = {
  1:"Pioneer Grace",
  2:"Peacemaker",
  3:"Psalmist",
  4:"Builder",
  5:"Holy Freedom",
  6:"Keeper of Covenant",
  7:"Mystic Scholar",
  8:"Steward of Influence",
  9:"Compassionate Finisher",
  11:"Prophetic Beacon",
  22:"Master Repairer",
  33:"Servant-Teacher"
};

const destinyMap = {
  1:{answer:"This theme carries a pioneer grace..."},
  2:{answer:"This theme carries the anointing of the peacemaker..."},
  3:{answer:"This theme is the psalmist‚Äôs banner..."},
  4:{answer:"This theme is the builder‚Äôs mantle..."},
  5:{answer:"This theme carries holy flexibility..."},
  6:{answer:"This theme bears the keeper‚Äôs heart..."},
  7:{answer:"This theme walks the path of the mystic scholar..."},
  8:{answer:"This theme is stewardship of influence..."},
  9:{answer:"This theme carries compassionate finishing..."},
  11:{answer:"This theme is the beacon..."},
  22:{answer:"This theme is the repairer..."},
  33:{answer:"This theme is the servant-teacher..."}
};

function handleCompute(){
  const name = qs('#nameInput').value.trim();
  const dob = qs('#dobInput').value.trim();
  const notice = qs('#calcNotice');

  const themeByDob = dob ? themeFromDob(dob) : null;
  const themeByName = name ? themeFromName(name) : null;

  const chosen = themeByDob || themeByName;

  if (!chosen){
    notice.textContent = "Enter a name or DOB to compute your theme.";
    qs('#resultCard').style.display = "none";
    return;
  }

  const entry = destinyMap[chosen];

  qs('#themeBadge').textContent = THEME_NAME[chosen] || "Destiny Theme";
  qs('#themeOrigin').textContent = themeByDob ? "Derived from your date of birth" : "Derived from your name";
  qs('#themeAnswer').textContent = entry.answer;
  qs('#resultCard').style.display = "block";
}

qs('#calcBtn').addEventListener('click', handleCompute);


/* ============================================================
   INITIALIZE
============================================================ */
document.getElementById("year").textContent = new Date().getFullYear();
loadVideos();
addMessage("bot", "Welcome, beloved. I‚Äôm Pastor Debra Jordan. Share your heart, or enter your name and optional DOB and I‚Äôll reflect with you on your Destiny Theme.");
</script>

</body>
</html>

